<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.26">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-201208347-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-201208347-1');
    </script><title>C++ 协程实现 | 苏格拉底儿</title><meta name="description" content="了解 C++ 协程实现，千万级别的并发不再是梦。">
    <link rel="preload" href="/assets/js/runtime~app.54a6bd6c.js" as="script"><link rel="preload" href="/assets/css/styles.eba7b0e1.css" as="style"><link rel="preload" href="/assets/js/812.bdfc5fea.js" as="script"><link rel="preload" href="/assets/js/app.fe5b7351.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.eba7b0e1.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">苏格拉底儿</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Tec"><span class="title">Tec</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Tec"><span class="title">Tec</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>C++</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/posts/cpp-base.html" class="nav-link" aria-label="基础 C++"><!--[--><!--]--> 基础 C++ <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/posts/cpp-modern.html" class="nav-link" aria-label="现代 C++"><!--[--><!--]--> 现代 C++ <!--[--><!--]--></a></li><li class="dropdown-subitem"><a aria-current="page" href="/posts/cpp-ucontext.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="C++ 协程实现"><!--[--><!--]--> C++ 协程实现 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>Windows</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/posts/duilib-source-code-analysis.html" class="nav-link" aria-label="DuiLib 源码剖析"><!--[--><!--]--> DuiLib 源码剖析 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Other"><span class="title">Other</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Other"><span class="title">Other</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/posts/interview.html" class="nav-link" aria-label="面试题解"><!--[--><!--]--> 面试题解 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Tec"><span class="title">Tec</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Tec"><span class="title">Tec</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>C++</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/posts/cpp-base.html" class="nav-link" aria-label="基础 C++"><!--[--><!--]--> 基础 C++ <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/posts/cpp-modern.html" class="nav-link" aria-label="现代 C++"><!--[--><!--]--> 现代 C++ <!--[--><!--]--></a></li><li class="dropdown-subitem"><a aria-current="page" href="/posts/cpp-ucontext.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="C++ 协程实现"><!--[--><!--]--> C++ 协程实现 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>Windows</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/posts/duilib-source-code-analysis.html" class="nav-link" aria-label="DuiLib 源码剖析"><!--[--><!--]--> DuiLib 源码剖析 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Other"><span class="title">Other</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Other"><span class="title">Other</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/posts/interview.html" class="nav-link" aria-label="面试题解"><!--[--><!--]--> 面试题解 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">C++ 协程实现</p><ul class=""><li><!--[--><a aria-current="page" href="/posts/cpp-ucontext.html#context-初体验" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="context 初体验"><!--[--><!--]--> context 初体验 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/posts/cpp-ucontext.html#ucontext-t-结构体" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ucontext_t 结构体"><!--[--><!--]--> ucontext_t 结构体 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/posts/cpp-ucontext.html#context-函数" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="context 函数"><!--[--><!--]--> context 函数 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/posts/cpp-ucontext.html#getcontext" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="getcontext"><!--[--><!--]--> getcontext <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/posts/cpp-ucontext.html#setcontext" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="setcontext"><!--[--><!--]--> setcontext <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/posts/cpp-ucontext.html#makecontext" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="makecontext"><!--[--><!--]--> makecontext <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/posts/cpp-ucontext.html#swapcontext" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="swapcontext"><!--[--><!--]--> swapcontext <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/posts/cpp-ucontext.html#进阶" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="进阶"><!--[--><!--]--> 进阶 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/posts/cpp-ucontext.html#参考链接" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="参考链接"><!--[--><!--]--> 参考链接 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="context-初体验" tabindex="-1"><a class="header-anchor" href="#context-初体验" aria-hidden="true">#</a> context 初体验</h2><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_XOPEN_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ucontext.h&gt;</span></span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ucontext_t context<span class="token punctuation">;</span>
 
    <span class="token function">getcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>上面的程序很简单，首先定义了一个保存上下文的结构体变量 <code>context</code>，调用 <code>getcontext</code> 函数获取当前的上下文内容，保存到 <code>context</code> 变量中，打印输出 Hello World，然后再设置一下上下文的内容。</p><p>不知道输出结果有没有猜对呢，没错，就是一直不断的输出 Hello World。下面我们来看看 context 相关的具体内容。</p><h2 id="ucontext-t-结构体" tabindex="-1"><a class="header-anchor" href="#ucontext-t-结构体" aria-hidden="true">#</a> ucontext_t 结构体</h2><p><code>uconext_t</code> 是一个结构体，里面定义了保存上下文所需要的所有内容，我们来看一下 macOS 系统头文件中它的定义：</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>_STRUCT_UCONTEXT
<span class="token punctuation">{</span>
  <span class="token keyword">int</span>                     uc_onstack<span class="token punctuation">;</span>
  __darwin_sigset_t       uc_sigmask<span class="token punctuation">;</span>     <span class="token comment">/* signal mask used by this context */</span>
  _STRUCT_SIGALTSTACK     uc_stack<span class="token punctuation">;</span>       <span class="token comment">/* stack used by this context */</span>
  _STRUCT_UCONTEXT        <span class="token operator">*</span>uc_link<span class="token punctuation">;</span>       <span class="token comment">/* pointer to resuming context */</span>
  __darwin_size_t         uc_mcsize<span class="token punctuation">;</span>      <span class="token comment">/* size of the machine context passed in */</span>
  _STRUCT_MCONTEXT        <span class="token operator">*</span>uc_mcontext<span class="token punctuation">;</span>   <span class="token comment">/* pointer to machine specific context */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_XOPEN_SOURCE</span></span>
  _STRUCT_MCONTEXT        __mcontext_data<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* _XOPEN_SOURCE */</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* user context */</span>
<span class="token keyword">typedef</span> _STRUCT_UCONTEXT        ucontext_t<span class="token punctuation">;</span>     <span class="token comment">/* [???] user context */</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>我们挑几个重要的变量来说明一下：</p><ol><li><code>uc_link</code>: 当当前上下文运行终止时系统会恢复<code>uc_link</code>指向的上下文。注意，如果该值为空，则当前上下文执行完后线程会直接退出。</li><li><code>uc_sigmask</code>: 为该上下文中的阻塞信号集合。</li><li><code>uc_stack</code>: 为该上下文中使用的栈。</li><li><code>uc_mcontext</code>: 保存的上下文的特定机器表示，包括调用线程的特定寄存器等，其实现方式依赖于底层运行的系统架构，是平台、硬件相关的。</li></ol><h2 id="context-函数" tabindex="-1"><a class="header-anchor" href="#context-函数" aria-hidden="true">#</a> context 函数</h2><p>跟上下文相关的函数一共只有 4 个，下面我们分别来看看吧。</p><h3 id="getcontext" tabindex="-1"><a class="header-anchor" href="#getcontext" aria-hidden="true">#</a> getcontext</h3><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">getcontext</span><span class="token punctuation">(</span>ucontext_t <span class="token operator">*</span>ucp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>该函数的作用是把当前的上下文保存到 ucp 所指向的内容空间中。</p><h3 id="setcontext" tabindex="-1"><a class="header-anchor" href="#setcontext" aria-hidden="true">#</a> setcontext</h3><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">setcontext</span><span class="token punctuation">(</span><span class="token keyword">const</span> ucontext_t <span class="token operator">*</span>ucp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>这个函数的作用是将当前程序执行切换到参数ucp所指向的上下文状态中。</p><p><code>setcontext</code> 的上下文 <code>ucp</code> 应该通过 <code>getcontext</code> 或者 <code>makecontext</code> 取得，如果调用成功则不返回。</p><p>如果上下文是通过调用 <code>getcontext</code> 取得，程序会继续执行这个调用。如果上下文是通过调用 <code>makecontext</code> 取得,程序会调用 <code>makecontext</code> 函数的第二个参数指向的函数，如果 <code>func</code> 函数返回，则恢复 <code>makecontext</code> 第一个参数指向的上下文第一个参数指向的上下文 <code>context_t</code> 中指向的 <code>uc_link</code>。如果 <code>uc_link</code> 为 <code>NULL</code>，则线程退出。</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// 通过修改一开始的例子，我们再来看看</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_XOPEN_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ucontext.h&gt;</span></span>

<span class="token keyword">static</span> ucontext_t context<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">getcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;hello world&quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ucontext_t main<span class="token punctuation">;</span>
  <span class="token function">setcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;ok\n&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code> ~/Projects/helloworld $ ./a.out           
hello world
hello world
ok
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// 再做一点简单的修改</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_XOPEN_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ucontext.h&gt;</span></span>

<span class="token keyword">static</span> ucontext_t context<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;hello world&quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> stack<span class="token punctuation">[</span><span class="token number">128</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">getcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>uc_link <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>uc_stack<span class="token punctuation">.</span>ss_sp <span class="token operator">=</span> stack<span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>uc_stack<span class="token punctuation">.</span>ss_size <span class="token operator">=</span> <span class="token number">128</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
  <span class="token function">makecontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// setcontext(&amp;context);</span>
  ucontext_t main<span class="token punctuation">;</span>
  <span class="token function">swapcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>main<span class="token punctuation">,</span> <span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;ok\n&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 从输出中发现，不管是 setcontext 还是 swapcontext 都不会输出 ok</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="makecontext" tabindex="-1"><a class="header-anchor" href="#makecontext" aria-hidden="true">#</a> makecontext</h3><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">makecontext</span><span class="token punctuation">(</span>ucontext_t <span class="token operator">*</span>ucp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>makecontext</code> 修改通过 <code>getcontext</code> 取得的上下文 <code>ucp</code> (这意味着调用 <code>makecontext</code> 前必须先调用 <code>getcontext</code>)。然后给该上下文指定一个栈空间 <code>ucp-&gt;stack</code>，设置后继的上下文 <code>ucp-&gt;uc_link</code>。</p><p>当上下文通过 <code>setcontext</code> 或者 <code>swapcontext</code> 激活后，执行 <code>func</code> 函数，<code>argc</code> 为 <code>func</code> 的参数个数，后面是 <code>func</code> 的参数序列。当 <code>func</code> 执行返回后，继承的上下文被激活，如果继承上下文为 <code>NULL</code> 时，线程退出。</p><h3 id="swapcontext" tabindex="-1"><a class="header-anchor" href="#swapcontext" aria-hidden="true">#</a> swapcontext</h3><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">swapcontext</span><span class="token punctuation">(</span>ucontext_t <span class="token operator">*</span>oucp<span class="token punctuation">,</span> ucontext_t <span class="token operator">*</span>ucp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>保存当前上下文到 <code>oucp</code> 结构体中，然后激活 <code>upc</code> 上下文。可以简单的把 <code>swapcontext = getcontext + setcontext</code>。</p><p>如果执行成功，getcontext 返回 0，setcontext 和 swapcontext不返回；如果执行失败，getcontext, setcontext, swapcontext 返回 -1，并设置对应的errno.</p><p>简单说来，getcontext 获取当前上下文，setcontext 设置当前上下文，swapcontext 切换上下文，makecontext 创建一个新的上下文。</p><h2 id="进阶" tabindex="-1"><a class="header-anchor" href="#进阶" aria-hidden="true">#</a> 进阶</h2><p>当你把协程相关的基础知识都弄懂弄透后，就可以开始着手协程库的事情，进一步学习请继续学习参考链接中的内容。</p><h2 id="参考链接" tabindex="-1"><a class="header-anchor" href="#参考链接" aria-hidden="true">#</a> 参考链接</h2><ol><li><a href="https://blog.csdn.net/qq910894904/article/details/41911175" target="_blank" rel="noopener noreferrer">ucontext-人人都可以实现的简单协程库<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="https://www.jianshu.com/p/c4de909fee75" target="_blank" rel="noopener noreferrer">云风基于C的协程库源码分析<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ol><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2021/9/23 上午9:04:46</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: liuzhcloud@gmail.com">Socrates</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.54a6bd6c.js" defer></script><script src="/assets/js/812.bdfc5fea.js" defer></script><script src="/assets/js/app.fe5b7351.js" defer></script>
  </body>
</html>
