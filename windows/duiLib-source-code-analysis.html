<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>DuiLib 源码剖析 | 苏格拉底儿</title><meta name="description" content="DuiLib 源码剖析，深度学习 DuiLib 的消息机制。"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.20">
    <link rel="preload" href="/assets/js/runtime~app.30a80d72.js" as="script"><link rel="preload" href="/assets/css/styles.b8cdc18b.css" as="style"><link rel="preload" href="/assets/js/640.bba7dc0e.js" as="script"><link rel="preload" href="/assets/js/app.e61e0044.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.b8cdc18b.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><!----><span class="site-name">苏格拉底儿</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Windows"><span class="title">Windows</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Windows"><span class="title">Windows</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/windows/duiLib-source-code-analysis.md" class="nav-link" aria-label="DuiLib 源码剖析"><!--[--><!--]--> DuiLib 源码剖析 <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Windows"><span class="title">Windows</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Windows"><span class="title">Windows</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/windows/duiLib-source-code-analysis.md" class="nav-link" aria-label="DuiLib 源码剖析"><!--[--><!--]--> DuiLib 源码剖析 <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">DuiLib 源码剖析</p><ul class=""><li><!--[--><a aria-current="page" href="/windows/duiLib-source-code-analysis.html#windows-消息机制" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Windows 消息机制"><!--[--><!--]--> Windows 消息机制 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/windows/duiLib-source-code-analysis.html#cwindowwnd-窗口基类" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="CWindowWnd 窗口基类"><!--[--><!--]--> CWindowWnd 窗口基类 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/windows/duiLib-source-code-analysis.html#windowimplbase-窗口实现类" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="WindowImplBase 窗口实现类"><!--[--><!--]--> WindowImplBase 窗口实现类 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/windows/duiLib-source-code-analysis.html#cdialogbuilder-xml文件解析类" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="CDialogBuilder xml文件解析类"><!--[--><!--]--> CDialogBuilder xml文件解析类 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/windows/duiLib-source-code-analysis.html#cpaintmanagerui-消息控件管理类" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="CPaintManagerUI 消息控件管理类"><!--[--><!--]--> CPaintManagerUI 消息控件管理类 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/windows/duiLib-source-code-analysis.html#ccontrolui-所有控件子类" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="CControlUI 所有控件子类"><!--[--><!--]--> CControlUI 所有控件子类 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/windows/duiLib-source-code-analysis.html#cnotifypump-消息泵的实现" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="CNotifyPump 消息泵的实现"><!--[--><!--]--> CNotifyPump 消息泵的实现 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/windows/duiLib-source-code-analysis.html#总结" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/windows/duiLib-source-code-analysis.html#其他" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="其他"><!--[--><!--]--> 其他 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="duilib-源码剖析" tabindex="-1"><a class="header-anchor" href="#duilib-源码剖析" aria-hidden="true">#</a> DuiLib 源码剖析</h1><h2 id="windows-消息机制" tabindex="-1"><a class="header-anchor" href="#windows-消息机制" aria-hidden="true">#</a> Windows 消息机制</h2><p><strong>UI线程：</strong> 创建窗口的线程必须就是处理窗口所有消息的线程，即<strong>UI线程</strong>（User Interface Thread）创建了窗体及窗体上的各种控件，系统为UI线程分配一个消息队列用于窗口消息的派送（dispatch）。为了使窗口处置这些消息，线程必须有它自己的“消息循环”。操作系统把<strong>非UI线程</strong>视作普通工作线程（Workhorse），不会为它创建消息队列。因此，调用PostThreadMessage前，这个线程必须是UI线程从而有投寄消息的队列</p><p><strong>窗体过程：</strong> 窗体过程（Window Procedure）是一个函数，每个窗体有一个窗体过程，负责处理该窗体的所有消息。UI控件也是独立的“Window”，拥有自己的“窗体过程”。</p><p><strong>消息队列：</strong></p><ol><li>Windows操作系统的内核空间中有一个系统消息队列（system message queue），在内核空间中还为每个UI线程分配各自的线程消息队列(Thread message queue)。在发生输入事件之后，Windows操作系统的输入设备驱动程序将输入事件转换为一个“消息”投寄到系统消息队列；操作系统的一个专门线程从系统消息队列取出消息，分发到各个UI线程的输入消息队列中。</li><li>应用程序的每个UI线程中有一段称之为“消息循环”的代码，通过<strong>GetMessage</strong>系统调用（或是<strong>PeekMessage</strong>系统调用）访问系统空间中的对应的UI线程的消息队列</li><li>需要注意的是，GetMessage如果在应用程序消息队列未获取消息，则GetMessage调用不返回，该线程挂起，CPU使用权交给操作系统。即GetMessage为阻塞调用。</li></ol><p>由此可见，Windows的事件驱动模式，并不是操作系统把消息主动分发给应用程序；而是由应用程序的每个UI线程通过“消息循环”代码从UI线程消息队列获取消息。</p><p>领悟：windows程序消息循环的机制</p><p>当一个应用程序建立的时候，操作系统会为该应用程序分配一个消息队列，凡是跟该程序相关的消息，操作系统都会把消息放到这个消息队列中，应用程序利用GetMessage从消息队列中取出一条具体的消息，利用TranslateMessage将WM_KEYDOWN和WM_KEYUP转换成一个WM_CHAR消息放到消息队列中。利用DispatchMessage将该消息投递出去，分发出去，分发给操作系统，操作系统利用设计窗口类时候指定的过程函数处理该消息。</p><h2 id="cwindowwnd-窗口基类" tabindex="-1"><a class="header-anchor" href="#cwindowwnd-窗口基类" aria-hidden="true">#</a> CWindowWnd 窗口基类</h2><p>CWindowWnd 类主要实现了Windows窗口窗口的过程，包括注册窗口类，窗口过程函数处理，创建窗口等。简单说下由父类实例调用 Create 函数开始，准备创建窗口过程。</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token comment">// 调用 Create 创建窗口</span>
    <span class="token operator">|</span><span class="token operator">-</span> <span class="token function">RegisterWindowClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 注册窗口类，指定自定义的窗口过程函数（静态成员函数）</span>
    <span class="token operator">|</span><span class="token operator">-</span> <span class="token double-colon punctuation">::</span><span class="token function">CreateWindow</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// 新建窗口，重要的是最后一个参数，把当前类地址传进去</span>
            <span class="token operator">|</span><span class="token operator">-</span> WM_NCCREATE <span class="token comment">// 首次创建窗口时在 WM_CREATE 消息之前发送。</span>
                <span class="token punctuation">{</span> 
                    <span class="token comment">// LPCREATESTRUCT.lpCreateParams 就是窗口创建时最后一个参数，可转换为 CWindowWnd* 的指针</span>
                    LPCREATESTRUCT lpcs <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>LPCREATESTRUCT<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pThis <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>CWindowWnd<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>lpcs<span class="token operator">-&gt;</span>lpCreateParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 设置一下窗口属性，USERDATA 用户数据属性设置为当前类的地址，后续可通过该属性获取类指针</span>
                    <span class="token double-colon punctuation">::</span><span class="token function">SetWindowLongPtr</span><span class="token punctuation">(</span>hWnd<span class="token punctuation">,</span> GWLP_USERDATA<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>LPARAM<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pThis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token operator">|</span><span class="token operator">-</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> WM_CREATE <span class="token comment">// 及后续的其他所有消息</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// 获取当前窗口类指针，通过 HandleMessage 回调到类中</span>
                    pThis <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>CWindowWnd<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span><span class="token function">GetWindowLongPtr</span><span class="token punctuation">(</span>hWnd<span class="token punctuation">,</span> GWLP_USERDATA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> pThis<span class="token operator">-&gt;</span><span class="token function">HandleMessage</span><span class="token punctuation">(</span>uMsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="windowimplbase-窗口实现类" tabindex="-1"><a class="header-anchor" href="#windowimplbase-窗口实现类" aria-hidden="true">#</a> WindowImplBase 窗口实现类</h2><p>该类简单的展示了DuiLib究竟要如何使用，我们可以从中看下实现方式。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>class WindowImplBase
    <span class="token operator">:</span> public CWindowWnd <span class="token comment">// 继承窗口类，创建窗口的任务还是要交给它</span>
    <span class="token punctuation">,</span> public CNotifyPump <span class="token comment">// 消息泵，宏消息实现的地方</span>
    <span class="token punctuation">,</span> public INotifyUI <span class="token comment">// 实现 Notify(TNotifyUI&amp; msg) 接口</span>
    <span class="token punctuation">,</span> public IMessageFilterUI <span class="token comment">// 实现 MessageHandler 接口</span>
    <span class="token punctuation">,</span> public IDialogBuilderCallback <span class="token comment">// 实现创建控件 CreateControl 的回调接口</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 以下只挑部分说明</span>
    virtual LRESULT <span class="token function">HandleMessage</span><span class="token punctuation">(</span>UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">)</span> <span class="token comment">// 实现了 CWindowWnd 所有消息回调接口，处理消息最原始的地方就是从这里开始</span>
    <span class="token punctuation">{</span>
        LRESULT lRes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        BOOL bHandled <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>uMsg<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">case</span> WM_CREATE<span class="token operator">:</span> lRes <span class="token operator">=</span> <span class="token function">OnCreate</span><span class="token punctuation">(</span>uMsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">,</span> bHandled<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// WM_CREATE 消息，定义一个函数处理初始化工作</span>
        <span class="token comment">// ...... 这里还有很多不展开说明了</span>
        <span class="token keyword">default</span><span class="token operator">:</span> bHandled <span class="token operator">=</span> FALSE<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bHandled<span class="token punctuation">)</span> <span class="token keyword">return</span> lRes<span class="token punctuation">;</span>

        lRes <span class="token operator">=</span> <span class="token function">HandleCustomMessage</span><span class="token punctuation">(</span>uMsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">,</span> bHandled<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义了一个虚函数，也就是如果继承该类的话，可以在父类重定义该类处理消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bHandled<span class="token punctuation">)</span> <span class="token keyword">return</span> lRes<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_PaintManager<span class="token punctuation">.</span><span class="token function">MessageHandler</span><span class="token punctuation">(</span>uMsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">,</span> lRes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// CPaintManager 会负责把相关消息封装成 TNotifyUI 形式通知 </span>
            <span class="token keyword">return</span> lRes<span class="token punctuation">;</span>
        <span class="token keyword">return</span> CWindowWnd<span class="token operator">::</span><span class="token function">HandleMessage</span><span class="token punctuation">(</span>uMsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    LRESULT WindowImplBase<span class="token operator">::</span><span class="token function">OnCreate</span><span class="token punctuation">(</span>UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">,</span> BOOL<span class="token operator">&amp;</span> bHandled<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        m_PaintManager<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>m_hWnd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化 CPaintManager</span>
        m_PaintManager<span class="token punctuation">.</span><span class="token function">AddPreMessageFilter</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册 IMessageFilterUI 接口， 实现 LRESULT MessageHandler(UINT uMsg, WPARAM wParam, LPARAM lParam, bool&amp; bHandled); 接口也能捕获到消息，但需要注意要捕获的消息类型会不会之前就被处理了</span>
        <span class="token comment">// ......</span>
        m_PaintManager<span class="token punctuation">.</span><span class="token function">AttachDialog</span><span class="token punctuation">(</span>pRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 把ui控件交给 pm 管理</span>
        m_PaintManager<span class="token punctuation">.</span><span class="token function">AddNotifier</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册 void Notify(TNotifyUI&amp; msg) = 0; 回调实现</span>

        <span class="token function">InitWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// DuiLib 窗口初始化完成，可以在该函数中实现自己业务相关的初始化操作</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h2 id="cdialogbuilder-xml文件解析类" tabindex="-1"><a class="header-anchor" href="#cdialogbuilder-xml文件解析类" aria-hidden="true">#</a> CDialogBuilder xml文件解析类</h2><p>该类主要负责读取 xml 文件，解析里面的控件和属性，生成对应UI控件，最后返回一个跟节点入口。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 以下代码属于 WindowImplBase OnCreate 函数中的节选部分</span>
CDialogBuilder builder<span class="token punctuation">;</span> <span class="token comment">// 创建一个实例</span>
CControlUI<span class="token operator">*</span> pRoot<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetResourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>UILIB_RESOURCE<span class="token punctuation">)</span> <span class="token comment">// 判断资源类型</span>
<span class="token punctuation">{</span>
    STRINGorID <span class="token function">xml</span><span class="token punctuation">(</span><span class="token function">_ttoi</span><span class="token punctuation">(</span><span class="token function">GetSkinFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>xml<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">&quot;xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m_PaintManager<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Create 函数中有两个参数要注意一下</span>
    <span class="token comment">// IDialogBuilderCallback 默认控件创建失败如果指定了该回调，会调用来创建实例</span>
    <span class="token comment">// CPaintManagerUI 1.设置窗口属性，保存全局的字体图片信息 2.可以注册插件，创建控件时也会到这里来尝试创建实例（静态方法）</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
    pRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token function">GetSkinFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UINT<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m_PaintManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
m_PaintManager<span class="token punctuation">.</span><span class="token function">AttachDialog</span><span class="token punctuation">(</span>pRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 把ui控件交给 pm 管理</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>CControlUI<span class="token operator">*</span> CDialogBuilder<span class="token operator">::</span><span class="token function">_Parse</span><span class="token punctuation">(</span>CMarkupNode<span class="token operator">*</span> pRoot<span class="token punctuation">,</span> CControlUI<span class="token operator">*</span> pParent<span class="token punctuation">,</span> CPaintManagerUI<span class="token operator">*</span> pManager<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    IContainerUI<span class="token operator">*</span> pContainer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    CControlUI<span class="token operator">*</span> pReturn <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> CMarkupNode node <span class="token operator">=</span> pRoot<span class="token operator">-&gt;</span><span class="token function">GetChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span> node<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">GetSibling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LPCTSTR pstrClass <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 以下这几个控件属性属于所有控件可用的，实际上它们的值会保存到 CPaintManagerUI 实例中，具体可查看调用前的 _Create 函数</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">_tcsicmp</span><span class="token punctuation">(</span>pstrClass<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">&quot;Image&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">_tcsicmp</span><span class="token punctuation">(</span>pstrClass<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">&quot;Font&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> \
            <span class="token operator">||</span> <span class="token function">_tcsicmp</span><span class="token punctuation">(</span>pstrClass<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">&quot;Default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> 
            <span class="token operator">||</span> <span class="token function">_tcsicmp</span><span class="token punctuation">(</span>pstrClass<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">&quot;MultiLanguage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

        CControlUI<span class="token operator">*</span> pControl <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">_tcsicmp</span><span class="token punctuation">(</span>pstrClass<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">&quot;Include&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ....</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// .... 内建控件实现</span>
            <span class="token comment">// User-supplied control factory</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> pControl <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CDuiPtrArray<span class="token operator">*</span> pPlugins <span class="token operator">=</span> CPaintManagerUI<span class="token operator">::</span><span class="token function">GetPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果内建控件没有，则判断 CPaintManagerUI 有没有对应的插件可用于构建控件</span>
                LPCREATECONTROL lpCreateControl <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pPlugins<span class="token operator">-&gt;</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lpCreateControl <span class="token operator">=</span> <span class="token punctuation">(</span>LPCREATECONTROL<span class="token punctuation">)</span>pPlugins<span class="token operator">-&gt;</span><span class="token function">GetAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span> lpCreateControl <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pControl <span class="token operator">=</span> <span class="token function">lpCreateControl</span><span class="token punctuation">(</span>pstrClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span> pControl <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> pControl <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> m_pCallback <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pControl <span class="token operator">=</span> m_pCallback<span class="token operator">-&gt;</span><span class="token function">CreateControl</span><span class="token punctuation">(</span>pstrClass<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果以上都创建失败，则使用 IDialogBuilderCallback 尝试</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// 下面这里就根据 xml 控件的属性，给控件设置上去，所以，没有文档也可以到对应控件下面看该函数，就能知道当前支持的属性有哪些</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> node<span class="token punctuation">.</span><span class="token function">HasAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Set ordinary attributes</span>
            <span class="token keyword">int</span> nAttributes <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">GetAttributeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nAttributes<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pControl<span class="token operator">-&gt;</span><span class="token function">SetAttribute</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">GetAttributeName</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">GetAttributeValue</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="cpaintmanagerui-消息控件管理类" tabindex="-1"><a class="header-anchor" href="#cpaintmanagerui-消息控件管理类" aria-hidden="true">#</a> CPaintManagerUI 消息控件管理类</h2><p>这个类的内容很多，实现代码有3500+行，这里简单说说消息管理相关的内容，其他的查看源码基本都能理解。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 实际上查看库里面提供的例子，基本都是建完窗口并显示后，调用了以下的函数，这是个静态函数，无需先创建实例</span>
<span class="token comment">// 如果对 WinForm 开发有了解的话，其实这个就是 Windows 程序消息循环机制，只不过加了一步duilib的处理</span>
<span class="token keyword">int</span> CPaintManagerUI<span class="token operator">::</span><span class="token function">MessageLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    MSG msg <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token operator">::</span><span class="token function">GetMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 从消息队列里取出一条消息</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>CPaintManagerUI<span class="token operator">::</span><span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// duilib 对消息的处理</span>
            <span class="token operator">::</span><span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 翻译消息</span>
            <span class="token operator">::</span><span class="token function">DispatchMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 操作系统分发消息，会在对应窗口的窗口过程函数中再次处理</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">.</span>wParam<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这个就是在上面消息循环里调用的消息处理函数</span>
bool CPaintManagerUI<span class="token operator">::</span><span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> LPMSG pMsg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    UINT uStyle <span class="token operator">=</span> <span class="token function">GetWindowStyle</span><span class="token punctuation">(</span>pMsg<span class="token operator">-&gt;</span>hwnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    UINT uChildRes <span class="token operator">=</span> uStyle <span class="token operator">&amp;</span> WS_CHILD<span class="token punctuation">;</span>    
    LRESULT lRes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uChildRes <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// 获取当前消息所属的窗口是否属于子窗口</span>
    <span class="token punctuation">{</span>
        HWND hWndParent <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">GetParent</span><span class="token punctuation">(</span>pMsg<span class="token operator">-&gt;</span>hwnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// m_aPreMessages 变量存储的就是每个 CPaintManagerUI 的实例</span>
        <span class="token comment">// 对前面内容还有印象的话，就知道，WindowImplBase 窗口在 OnCreate 创建过程中曾 bind 了句柄到 CPaintManagerUI 中</span>
        <span class="token comment">// 同时会把 CPaintManagerUI 实例指针放入到该数组中</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> m_aPreMessages<span class="token punctuation">.</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">;</span> <span class="token operator">--</span>i <span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
            CPaintManagerUI<span class="token operator">*</span> pT <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span>CPaintManagerUI<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>m_aPreMessages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
            HWND hTempParent <span class="token operator">=</span> hWndParent<span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>hTempParent<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// 向上获取父窗口句柄，该链条上的所有句柄是否有属于该 CPaintManagerUI 实例管理的</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>pMsg<span class="token operator">-&gt;</span>hwnd <span class="token operator">==</span> pT<span class="token operator">-&gt;</span><span class="token function">GetPaintWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> hTempParent <span class="token operator">==</span> pT<span class="token operator">-&gt;</span><span class="token function">GetPaintWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                      <span class="token comment">// Windows 自带的该函数是将 快捷键 转换为命令消息发出去</span>
                      <span class="token comment">// 这个需要自己注册 ITranslateAccelerator 接口，它会回调到注册函数里处理，暂时不讨论了</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pT<span class="token operator">-&gt;</span><span class="token function">TranslateAccelerator</span><span class="token punctuation">(</span>pMsg<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> true<span class="token punctuation">;</span>
                    <span class="token comment">// 里面实现了预消息处理函数，下面我们再看看这里的实现</span>
                    pT<span class="token operator">-&gt;</span><span class="token function">PreMessageHandler</span><span class="token punctuation">(</span>pMsg<span class="token operator">-&gt;</span>message<span class="token punctuation">,</span> pMsg<span class="token operator">-&gt;</span>wParam<span class="token punctuation">,</span> pMsg<span class="token operator">-&gt;</span>lParam<span class="token punctuation">,</span> lRes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                hTempParent <span class="token operator">=</span> <span class="token function">GetParent</span><span class="token punctuation">(</span>hTempParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token punctuation">;</span> <span class="token comment">// 非子窗口的处理与上面基本一致，只是没有获取父窗口判断那一步而已 </span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 预处理消息</span>
bool CPaintManagerUI<span class="token operator">::</span><span class="token function">PreMessageHandler</span><span class="token punctuation">(</span>UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">,</span> LRESULT<span class="token operator">&amp;</span> <span class="token comment">/*lRes*/</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// m_aPreMessageFilters 数组管理着 IMessageFilterUI 接口的实现对象实例</span>
    <span class="token comment">// 结合前面的 WindowImplBase 类，它是不是继承了 IMessageFilterUI 接口类，然后实现了 MessageHandler 函数，原来消息是来这这里</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m_aPreMessageFilters<span class="token punctuation">.</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        bool bHandled <span class="token operator">=</span> false<span class="token punctuation">;</span>
        LRESULT lResult <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span>IMessageFilterUI<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>m_aPreMessageFilters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">MessageHandler</span><span class="token punctuation">(</span>uMsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">,</span> bHandled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> bHandled <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span> uMsg <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> WM_KEYDOWN<span class="token operator">:</span>
        <span class="token comment">// 处理 Tab 键切换焦点</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> WM_SYSCHAR<span class="token operator">:</span>
        <span class="token comment">// 处理是否是快捷键</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> WM_SYSKEYDOWN<span class="token operator">:</span>
        <span class="token comment">// 给当前焦点控件发送系统按键信息</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><p>到这里，消息处理的链条就比较清晰了。我们记得，在 WindowImplBase 的 HanleMessage 中，在函数的最后，调用了 <code>m_PaintManager.MessageHandler(uMsg, wParam, lParam, lRes);</code>，这个也属于 CPaintManagerUI 中的消息处理函数，但这个也是最后一步消息处理了，我们来看看该函数的实现。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>bool CPaintManagerUI<span class="token operator">::</span><span class="token function">MessageHandler</span><span class="token punctuation">(</span>UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">,</span> LRESULT<span class="token operator">&amp;</span> lRes<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> m_hWndPaint <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token comment">// 这里还有个消息过滤，也是实现 IMessageFilterUI 接口，m_aMessageFilters 和 m_aPreMessageFilters 的区别就是调用顺序的不同</span>
    <span class="token comment">// 想要注册这两个回调，调用的两个接口如下，所以根据你想要捕获的消息，需要分辨一下要在注册回调的时机</span>
    <span class="token comment">// bool AddPreMessageFilter(IMessageFilterUI* pFilter);</span>
    <span class="token comment">// bool AddMessageFilter(IMessageFilterUI* pFilter);</span>
    <span class="token comment">// 在 WindowImplBase 类中，调用的是 m_PaintManager.AddPreMessageFilter(this); 所以你知道该类中各个消息回调的顺序了吗？</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m_aMessageFilters<span class="token punctuation">.</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        bool bHandled <span class="token operator">=</span> false<span class="token punctuation">;</span>
        LRESULT lResult <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span>IMessageFilterUI<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>m_aMessageFilters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">MessageHandler</span><span class="token punctuation">(</span>uMsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">,</span> bHandled<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> bHandled <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这里返回这里更新了鼠标最后的位置坐标</span>
            <span class="token keyword">return</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ....</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span> uMsg <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> WM_APP <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">:</span>
        <span class="token comment">// 这个消息用来处理异步的通知事件，还有控件延迟删除时也是会放到这里执行</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> WM_CLOSE<span class="token operator">:</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Make sure all matching &quot;closing&quot; events are sent</span>
            TEventUI event <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span>ptMouse <span class="token operator">=</span> m_ptLastMousePos<span class="token punctuation">;</span>
            event<span class="token punctuation">.</span>wKeyState <span class="token operator">=</span> <span class="token function">MapKeyState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span>dwTimestamp <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> m_pEventHover <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                event<span class="token punctuation">.</span>Type <span class="token operator">=</span> UIEVENT_MOUSELEAVE<span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>pSender <span class="token operator">=</span> m_pEventHover<span class="token punctuation">;</span>
                m_pEventHover<span class="token operator">-&gt;</span><span class="token function">Event</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> m_pEventClick <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                event<span class="token punctuation">.</span>Type <span class="token operator">=</span> UIEVENT_BUTTONUP<span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>pSender <span class="token operator">=</span> m_pEventClick<span class="token punctuation">;</span>
                m_pEventClick<span class="token operator">-&gt;</span><span class="token function">Event</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">SetFocus</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">::</span><span class="token function">GetActiveWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> m_hWndPaint <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                HWND hwndParent <span class="token operator">=</span> <span class="token function">GetWindowOwner</span><span class="token punctuation">(</span>m_hWndPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">GetWindowStyle</span><span class="token punctuation">(</span>m_hWndPaint<span class="token punctuation">)</span> <span class="token operator">&amp;</span> WS_CHILD<span class="token punctuation">)</span> <span class="token operator">!=</span><span class="token number">0</span> <span class="token punctuation">)</span> hwndParent <span class="token operator">=</span> <span class="token function">GetParent</span><span class="token punctuation">(</span>m_hWndPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> hwndParent <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token operator">::</span><span class="token function">SetFocus</span><span class="token punctuation">(</span>hwndParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_hwndTooltip <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">::</span><span class="token function">DestroyWindow</span><span class="token punctuation">(</span>m_hwndTooltip<span class="token punctuation">)</span><span class="token punctuation">;</span>
                m_hwndTooltip <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> WM_ERASEBKGND<span class="token operator">:</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// We&#39;ll do the painting here...</span>
            lRes <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> true<span class="token punctuation">;</span>
    <span class="token keyword">case</span> WM_PAINT<span class="token operator">:</span>
        <span class="token comment">// 界面绘画这块内容很长，有时间可以好好看看</span>
        <span class="token keyword">return</span> true<span class="token punctuation">;</span>
    <span class="token comment">// ... 后面的消息处理函数太多了，最后说下定时消息，看下DuiLib内部的控件消息 OnNotify 是如何实现的</span>
    <span class="token keyword">case</span> WM_TIMER<span class="token operator">:</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">LOWORD</span><span class="token punctuation">(</span>wParam<span class="token punctuation">)</span> <span class="token operator">==</span> LAYEREDUPDATE_TIMERID <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 分层更新消息</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> m_bLayered <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">::</span><span class="token function">IsRectEmpty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m_rcLayeredUpdate<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    LRESULT lRes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">::</span><span class="token function">IsIconic</span><span class="token punctuation">(</span>m_hWndPaint<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token function">MessageHandler</span><span class="token punctuation">(</span>WM_PAINT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> lRes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// m_aTimers 是设置了定时的控件的集合，控件设置请调用 CPaintManagerUI::SetTimer 函数</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m_aTimers<span class="token punctuation">.</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> TIMERINFO<span class="token operator">*</span> pTimer <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span>TIMERINFO<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>m_aTimers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> pTimer<span class="token operator">-&gt;</span>hWnd <span class="token operator">==</span> m_hWndPaint <span class="token operator">&amp;&amp;</span> pTimer<span class="token operator">-&gt;</span>uWinTimer <span class="token operator">==</span> <span class="token function">LOWORD</span><span class="token punctuation">(</span>wParam<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pTimer<span class="token operator">-&gt;</span>bKilled <span class="token operator">==</span> false<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 判断定时消息是否应该发送，这里可以看到 DuiLib 是如何封装并通知控件的</span>
                    TEventUI event <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>             <span class="token comment">// 定义一个 TEventUI 结构实例</span>
                    event<span class="token punctuation">.</span>Type <span class="token operator">=</span> UIEVENT_TIMER<span class="token punctuation">;</span>            <span class="token comment">// 消息类型属于 定时消息</span>
                    event<span class="token punctuation">.</span>pSender <span class="token operator">=</span> pTimer<span class="token operator">-&gt;</span>pSender<span class="token punctuation">;</span>     <span class="token comment">// 发送消息的控件 </span>
                    event<span class="token punctuation">.</span>dwTimestamp <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    event<span class="token punctuation">.</span>ptMouse <span class="token operator">=</span> m_ptLastMousePos<span class="token punctuation">;</span>    <span class="token comment">// 鼠标最后的位置</span>
                    event<span class="token punctuation">.</span>wKeyState <span class="token operator">=</span> <span class="token function">MapKeyState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 系统按键的状态</span>
                    event<span class="token punctuation">.</span>wParam <span class="token operator">=</span> pTimer<span class="token operator">-&gt;</span>nLocalID<span class="token punctuation">;</span>    <span class="token comment">// 消息的标识 ID</span>
                    event<span class="token punctuation">.</span>lParam <span class="token operator">=</span> lParam<span class="token punctuation">;</span>                <span class="token comment">// 原来的内容</span>
                    pTimer<span class="token operator">-&gt;</span>pSender<span class="token operator">-&gt;</span><span class="token function">Event</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 控件调用处理上面的消息</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><h2 id="ccontrolui-所有控件子类" tabindex="-1"><a class="header-anchor" href="#ccontrolui-所有控件子类" aria-hidden="true">#</a> CControlUI 所有控件子类</h2><p>这个是实现控件时都要继承的基类，定义了一些基本的属性和方法，这些内容基本过一遍源码即可，相对来说也比较好理解。想要实现自定义控件的时候，最好是了解一下各个函数的作用，自定义的控件需不需要覆盖，这些都是要考虑的。</p><p>下面我们就接着上面的内容继续看下控件的消息机制。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 从 CPaintManager 过来的消息，这个函数就作为入口</span>
<span class="token keyword">void</span> CControlUI<span class="token operator">::</span><span class="token function">Event</span><span class="token punctuation">(</span>TEventUI<span class="token operator">&amp;</span> event<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">OnEvent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token function">DoEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// OnEvent 是个 CEventSource 的实例， 而这个 CEventSource 又是什么东西呢</span>
CEventSource OnEvent<span class="token punctuation">;</span>

<span class="token comment">// CEventSource 是一个类，可以看到它有个指针数组，没猜错的话应该就是注册消息回调相关的了</span>
class DUILIB_API CEventSource
<span class="token punctuation">{</span>
    <span class="token keyword">typedef</span> <span class="token function">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span>FnType<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
public<span class="token operator">:</span>
    <span class="token operator">~</span><span class="token function">CEventSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    operator <span class="token function">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> operator<span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> CDelegateBase<span class="token operator">&amp;</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add const for gcc</span>
    <span class="token keyword">void</span> operator<span class="token operator">+=</span> <span class="token punctuation">(</span>FnType pFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> operator<span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> CDelegateBase<span class="token operator">&amp;</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> operator<span class="token operator">-=</span> <span class="token punctuation">(</span>FnType pFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool <span class="token function">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
protected<span class="token operator">:</span>
    CDuiPtrArray m_aDelegates<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 我们继续看上面 OnEvent(&amp;event) 的调用，实际上调用了这个函数</span>
bool CEventSource<span class="token operator">::</span><span class="token function">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> param<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token comment">// 这里实际上就是遍历了数组，数组保存的内容是一个 CDelegateBase 指针，重载+=时添加的</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m_aDelegates<span class="token punctuation">.</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CDelegateBase<span class="token operator">*</span> pObject <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span>CDelegateBase<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>m_aDelegates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pObject <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>pObject<span class="token punctuation">)</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 试着搜索了一下，发现并没有地方用到这个变量，但它自带的demo里是有用到的，可以看看用法</span>
log_button<span class="token operator">-&gt;</span>OnEvent <span class="token operator">+=</span> <span class="token function">MakeDelegate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>OnLogoButtonEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 一个Button实例，添加了消息回调，回调函数如下，和上面对应上了</span>
<span class="token keyword">static</span> bool <span class="token function">OnLogoButtonEvent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>TEventUI<span class="token operator">*</span><span class="token punctuation">)</span>event<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Type <span class="token operator">==</span> UIEVENT_BUTTONDOWN <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CControlUI<span class="token operator">*</span> pButton <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>TEventUI<span class="token operator">*</span><span class="token punctuation">)</span>event<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pSender<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> pButton <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            CListContainerElementUI<span class="token operator">*</span> pListElement <span class="token operator">=</span> <span class="token punctuation">(</span>CListContainerElementUI<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pButton<span class="token operator">-&gt;</span><span class="token function">GetTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> pListElement <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> pListElement<span class="token operator">-&gt;</span><span class="token function">DoEvent</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>TEventUI<span class="token operator">*</span><span class="token punctuation">)</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 回到一开始我们再看它调用，OnEvent 只要没有失败，还是会继续执行 DoEvent 的</span>
<span class="token comment">// 那我们继续再看 DoEvent 里面的实现</span>
<span class="token keyword">void</span> CControlUI<span class="token operator">::</span><span class="token function">DoEvent</span><span class="token punctuation">(</span>TEventUI<span class="token operator">&amp;</span> event<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// .... 省略其他一些事件处理函数，这里我们继续看定时消息的处理</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> event<span class="token punctuation">.</span>Type <span class="token operator">==</span> UIEVENT_TIMER <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 这里突然又开始调用 CPaintManagerUI 的函数，看来消息的真正处理函数还是在 CPaintManagerUI 里面管理</span>
        m_pManager<span class="token operator">-&gt;</span><span class="token function">SendNotify</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> DUI_MSGTYPE_TIMER<span class="token punctuation">,</span> event<span class="token punctuation">.</span>wParam<span class="token punctuation">,</span> event<span class="token punctuation">.</span>lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> m_pParent <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> m_pParent<span class="token operator">-&gt;</span><span class="token function">DoEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// SendNotify 有个重载函数，我们直接看实现的这个</span>
<span class="token keyword">void</span> CPaintManagerUI<span class="token operator">::</span><span class="token function">SendNotify</span><span class="token punctuation">(</span>TNotifyUI<span class="token operator">&amp;</span> Msg<span class="token punctuation">,</span> bool bAsync <span class="token comment">/*= false*/</span><span class="token punctuation">,</span> bool bEnableRepeat <span class="token comment">/*= true*/</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Msg<span class="token punctuation">.</span>ptMouse <span class="token operator">=</span> m_ptLastMousePos<span class="token punctuation">;</span>
    Msg<span class="token punctuation">.</span>dwTimestamp <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> m_bUsedVirtualWnd <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>    <span class="token comment">// 这里判断有没有使用虚窗口，如果有的话把消息结构加上虚窗口标识</span>
        Msg<span class="token punctuation">.</span>sVirtualWnd <span class="token operator">=</span> Msg<span class="token punctuation">.</span>pSender<span class="token operator">-&gt;</span><span class="token function">GetVirtualWnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>bAsync <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> Msg<span class="token punctuation">.</span>pSender <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 判断消息发送窗口 OnNotify 变量有没有绑定回调，有的话则调用（和前面 OnEvent 一样）</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> Msg<span class="token punctuation">.</span>pSender<span class="token operator">-&gt;</span>OnNotify <span class="token punctuation">)</span> Msg<span class="token punctuation">.</span>pSender<span class="token operator">-&gt;</span><span class="token function">OnNotify</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// m_aNotifiers 是 INotifyUI 接口类型指针的数组，也是通过 AddNotifier 注册</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m_aNotifiers<span class="token punctuation">.</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            static_cast<span class="token operator">&lt;</span>INotifyUI<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>m_aNotifiers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Notify</span><span class="token punctuation">(</span>Msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        TNotifyUI <span class="token operator">*</span>pMsg <span class="token operator">=</span> new TNotifyUI<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_bUsedVirtualWnd<span class="token punctuation">)</span> pMsg<span class="token operator">-&gt;</span>sVirtualWnd <span class="token operator">=</span> Msg<span class="token punctuation">.</span>sVirtualWnd<span class="token punctuation">;</span>
        pMsg<span class="token operator">-&gt;</span>pSender <span class="token operator">=</span> Msg<span class="token punctuation">.</span>pSender<span class="token punctuation">;</span>
        pMsg<span class="token operator">-&gt;</span>sType <span class="token operator">=</span> Msg<span class="token punctuation">.</span>sType<span class="token punctuation">;</span>
        pMsg<span class="token operator">-&gt;</span>wParam <span class="token operator">=</span> Msg<span class="token punctuation">.</span>wParam<span class="token punctuation">;</span>
        pMsg<span class="token operator">-&gt;</span>lParam <span class="token operator">=</span> Msg<span class="token punctuation">.</span>lParam<span class="token punctuation">;</span>
        pMsg<span class="token operator">-&gt;</span>ptMouse <span class="token operator">=</span> Msg<span class="token punctuation">.</span>ptMouse<span class="token punctuation">;</span>
        pMsg<span class="token operator">-&gt;</span>dwTimestamp <span class="token operator">=</span> Msg<span class="token punctuation">.</span>dwTimestamp<span class="token punctuation">;</span>
        m_aAsyncNotify<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>pMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里是异步调用，直接发送 WM_APP + 1 消息稍后处理</span>
        <span class="token function">PostAsyncNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 最后我们再回到 WindowImplBase 窗口类</span>
class DUILIB_API WindowImplBase
    <span class="token operator">:</span> public CWindowWnd
        <span class="token punctuation">,</span> public CNotifyPump <span class="token comment">// 消息泵，实现虚窗口消息转发，实现声明消息宏转发</span>
        <span class="token punctuation">,</span> public INotifyUI <span class="token comment">// 实现 Notify 接口</span>
        <span class="token punctuation">,</span> public IMessageFilterUI
        <span class="token punctuation">,</span> public IDialogBuilderCallback
    <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 在 OnCrate 窗口初始化函数里面，把当前 INotifyUI 注册到 CPaintManagerUI 中去，那么 SendNotify 时就会收到通知</span>
m_PaintManager<span class="token punctuation">.</span><span class="token function">AddNotifier</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 该窗口收到回调信息，再转发到 CNotifyPump 虚窗口中去，CNotifyPump 里面实现宏定义消息的调用</span>
<span class="token keyword">void</span> WindowImplBase<span class="token operator">::</span><span class="token function">Notify</span><span class="token punctuation">(</span>TNotifyUI<span class="token operator">&amp;</span> msg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> CNotifyPump<span class="token operator">::</span><span class="token function">NotifyPump</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br></div></div><h2 id="cnotifypump-消息泵的实现" tabindex="-1"><a class="header-anchor" href="#cnotifypump-消息泵的实现" aria-hidden="true">#</a> CNotifyPump 消息泵的实现</h2><p>该类就负责实现 DuiLib 中类似 MFC 的宏定义消息，可定义点击按钮事件的回调函数或者其他的，下面来看看它的实现。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 这里就是由 WindowImplBase 类转发进来的消息</span>
<span class="token keyword">void</span> CNotifyPump<span class="token operator">::</span><span class="token function">NotifyPump</span><span class="token punctuation">(</span>TNotifyUI<span class="token operator">&amp;</span> msg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">///遍历虚拟窗口</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span>sVirtualWnd<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 如果该消息来自虚拟窗口，则转发到对应的虚拟窗口的 CNotifyPump 处理函数中</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> m_VirtualWndMap<span class="token punctuation">.</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> LPCTSTR key <span class="token operator">=</span> m_VirtualWndMap<span class="token punctuation">.</span><span class="token function">GetAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">_tcsicmp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sVirtualWnd<span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    CNotifyPump<span class="token operator">*</span> pObject <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span>CNotifyPump<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>m_VirtualWndMap<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span> pObject <span class="token operator">&amp;&amp;</span> pObject<span class="token operator">-&gt;</span><span class="token function">LoopDispatch</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token punctuation">)</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//遍历主窗口，下面消息真正的分发处理</span>
    <span class="token function">LoopDispatch</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 我们先看看这个类中宏定义的内容</span>
<span class="token keyword">struct</span> <span class="token class-name">DUI_MSGMAP</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> DUI_MSGMAP<span class="token operator">*</span> <span class="token punctuation">(</span>PASCAL<span class="token operator">*</span> pfnGetBaseMap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 函数指针返回一个当前类型的结构体指针</span>
    <span class="token keyword">const</span> DUI_MSGMAP_ENTRY<span class="token operator">*</span> lpEntries<span class="token punctuation">;</span> <span class="token comment">// 指向 DUI_MSGMAP_ENTRY 数组的指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">DUI_MSGMAP_ENTRY</span> <span class="token comment">//定义一个结构体，来存放消息信息</span>
<span class="token punctuation">{</span>
    CDuiString sMsgType<span class="token punctuation">;</span>          <span class="token comment">// DUI消息类型</span>
    CDuiString sCtrlName<span class="token punctuation">;</span>         <span class="token comment">// 控件名称</span>
    UINT       nSig<span class="token punctuation">;</span>              <span class="token comment">// 标记函数指针类型</span>
    DUI_PMSG   pfn<span class="token punctuation">;</span>               <span class="token comment">// 指向函数的指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// DUI_DECLARE_MESSAGE_MAP 头文件中声明的宏内容，为了好看，直接就转成类的形式查看</span>
class CNotifyPump <span class="token punctuation">{</span>
private<span class="token operator">:</span>                                                                  
    <span class="token keyword">static</span> <span class="token keyword">const</span> DUI_MSGMAP_ENTRY _messageEntries<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 一个存储消息处理函数的数组</span>
protected<span class="token operator">:</span>                                                                
    <span class="token keyword">static</span> <span class="token keyword">const</span> DUI_MSGMAP messageMap<span class="token punctuation">;</span> <span class="token comment">// 一个 DUI_MSGMAP 的变量</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> DUI_MSGMAP<span class="token operator">*</span> PASCAL <span class="token function">_GetBaseMessageMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    virtual <span class="token keyword">const</span> DUI_MSGMAP<span class="token operator">*</span> <span class="token function">GetMessageMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token comment">// DUI_BASE_BEGIN_MESSAGE_MAP(theClass)</span>
<span class="token keyword">const</span> DUI_MSGMAP<span class="token operator">*</span> PASCAL CNotifyPump<span class="token operator">::</span><span class="token function">_GetBaseMessageMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>   <span class="token comment">// 如果是子类定义：这个为基类的 &amp;baseClass::messageMap</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> DUI_MSGMAP<span class="token operator">*</span> CNotifyPump<span class="token operator">::</span><span class="token function">GetMessageMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>CNotifyPump<span class="token operator">::</span>messageMap<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
UILIB_COMDAT <span class="token keyword">const</span> DUI_MSGMAP CNotifyPump<span class="token operator">::</span>messageMap <span class="token operator">=</span> <span class="token comment">// 初始化为指向两个成员变量</span>
    <span class="token punctuation">{</span> <span class="token operator">&amp;</span>CNotifyPump<span class="token operator">::</span>_GetBaseMessageMap<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CNotifyPump<span class="token operator">::</span>_messageEntries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
UILIB_COMDAT <span class="token keyword">const</span> DUI_MSGMAP_ENTRY CNotifyPump<span class="token operator">::</span>_messageEntries<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token comment">// DUI_END_MESSAGE_MAP() </span>
    <span class="token punctuation">{</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> DuiSig_end<span class="token punctuation">,</span> <span class="token punctuation">(</span>DUI_PMSG<span class="token punctuation">)</span><span class="token number">0</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

bool CNotifyPump<span class="token operator">::</span><span class="token function">LoopDispatch</span><span class="token punctuation">(</span>TNotifyUI<span class="token operator">&amp;</span> msg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> DUI_MSGMAP_ENTRY<span class="token operator">*</span> lpEntry <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> DUI_MSGMAP<span class="token operator">*</span> pMessageMap <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">// GetMessage 是虚函数，获取真正的 messgeMap 地址</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>pMessageMap <span class="token operator">=</span> <span class="token function">GetMessageMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pMessageMap<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">;</span> pMessageMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pMessageMap<span class="token operator">-&gt;</span>pfnGetBaseMap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// pMessageMap 是当前类的 messageMap 指针，(*pMessageMap-&gt;pfnGetBaseMap)() 获取的是基类的 messageMap 指针</span>
        <span class="token comment">// CNotifyPump 作为基类 (*pMessageMap-&gt;pfnGetBaseMap)() 返回的是 NULL</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span>pMessageMap <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pMessageMap<span class="token operator">-&gt;</span>pfnGetBaseMap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 循环遍历数组，找到合适的回调函数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lpEntry <span class="token operator">=</span> <span class="token function">DuiFindMessageEntry</span><span class="token punctuation">(</span>pMessageMap<span class="token operator">-&gt;</span>lpEntries<span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">goto</span> LDispatch<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span> <span class="token comment">// 没找到直接返回不处理</span>

LDispatch<span class="token operator">:</span>
    <span class="token keyword">union</span> DuiMessageMapFunctions mmf<span class="token punctuation">;</span>
    mmf<span class="token punctuation">.</span>pfn <span class="token operator">=</span> lpEntry<span class="token operator">-&gt;</span>pfn<span class="token punctuation">;</span>

    bool bRet <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nSig<span class="token punctuation">;</span>
    nSig <span class="token operator">=</span> lpEntry<span class="token operator">-&gt;</span>nSig<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>nSig<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">ASSERT</span><span class="token punctuation">(</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> DuiSig_lwl<span class="token operator">:</span>
        <span class="token punctuation">(</span>this<span class="token operator">-&gt;</span><span class="token operator">*</span>mmf<span class="token punctuation">.</span>pfn_Notify_lwl<span class="token punctuation">)</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>wParam<span class="token punctuation">,</span>msg<span class="token punctuation">.</span>lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bRet <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> DuiSig_vn<span class="token operator">:</span>
        <span class="token punctuation">(</span>this<span class="token operator">-&gt;</span><span class="token operator">*</span>mmf<span class="token punctuation">.</span>pfn_Notify_vn<span class="token punctuation">)</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bRet <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bRet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 以上，终于把所有的消息响应的内容搞定了</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>通过上面的学习，基本上 DuiLib 里面的消息循环内容就全部学完了，怎么样，你学废了吗？</p><p>再次汇总总结一下所有消息的流程：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>CPaintManagerUI<span class="token operator">::</span><span class="token function">MessageLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">|</span><span class="token operator">-</span> CPaintManagerUI<span class="token operator">::</span><span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> 
        <span class="token operator">|</span><span class="token operator">-</span> IMessageFilterUI<span class="token operator">::</span><span class="token function">MessageHandler</span><span class="token punctuation">(</span>UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">,</span> bool<span class="token operator">&amp;</span> bHandled<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// bool AddPreMessageFilter(IMessageFilterUI* pFilter);</span>
        <span class="token operator">|</span><span class="token operator">-</span> CWindowWnd<span class="token operator">::</span><span class="token function">__WndProc</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">,</span> UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">)</span>
            <span class="token operator">|</span><span class="token operator">-</span> WindowImplBase<span class="token operator">::</span><span class="token function">HandleMessage</span><span class="token punctuation">(</span>UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">)</span>
                <span class="token operator">|</span><span class="token operator">-</span> WindowImplBase<span class="token operator">::</span><span class="token function">HandleCustomMessage</span><span class="token punctuation">(</span>UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">,</span> BOOL<span class="token operator">&amp;</span> bHandled<span class="token punctuation">)</span>
                <span class="token operator">|</span><span class="token operator">-</span> CPaintManagerUI<span class="token operator">::</span><span class="token function">MessageHandler</span><span class="token punctuation">(</span>UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">,</span> LRESULT<span class="token operator">&amp;</span> lRes<span class="token punctuation">)</span>
                    <span class="token operator">|</span><span class="token operator">-</span> IMessageFilterUI<span class="token operator">::</span><span class="token function">MessageHandler</span><span class="token punctuation">(</span>UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">,</span> bool<span class="token operator">&amp;</span> bHandled<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// bool AddMessageFilter(IMessageFilterUI* pFilter);</span>
                    <span class="token operator">|</span><span class="token operator">-</span> CControlUI<span class="token operator">::</span><span class="token function">Event</span><span class="token punctuation">(</span>TEventUI<span class="token operator">&amp;</span> event<span class="token punctuation">)</span>
                        <span class="token operator">|</span><span class="token operator">-</span> CControlUI<span class="token operator">::</span>OnEvent
                        <span class="token operator">|</span><span class="token operator">-</span> CControlUI<span class="token operator">::</span><span class="token function">DoEvent</span><span class="token punctuation">(</span>TEventUI<span class="token operator">&amp;</span> event<span class="token punctuation">)</span>
                            <span class="token operator">|</span><span class="token operator">-</span> CPaintManagerUI<span class="token operator">::</span><span class="token function">SendNotify</span><span class="token punctuation">(</span>CControlUI<span class="token operator">*</span> pControl<span class="token punctuation">,</span> LPCTSTR pstrMessage<span class="token punctuation">,</span> WPARAM wParam <span class="token comment">/*= 0*/</span><span class="token punctuation">,</span> LPARAM lParam <span class="token comment">/*= 0*/</span><span class="token punctuation">,</span> bool bAsync <span class="token comment">/*= false*/</span><span class="token punctuation">,</span> bool bEnableRepeat <span class="token comment">/*= true*/</span><span class="token punctuation">)</span>
                                <span class="token operator">|</span><span class="token operator">-</span> WindowImplBase<span class="token operator">::</span><span class="token function">Notify</span><span class="token punctuation">(</span>TNotifyUI<span class="token operator">&amp;</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// INotifyUI::Notify(TNotifyUI&amp; msg) = 0;</span>
                                    <span class="token operator">|</span><span class="token operator">-</span> CNotifyPump<span class="token operator">::</span><span class="token function">NotifyPump</span><span class="token punctuation">(</span>TNotifyUI<span class="token operator">&amp;</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="其他" tabindex="-1"><a class="header-anchor" href="#其他" aria-hidden="true">#</a> 其他</h2><p><strong>DllMain</strong> 入口函数，Windows 在加载动态库的时候会查找并执行该函数，作为调用的依据，和 main 函数的一样。</p><p><strong>SubclassWindow</strong> 简单讲就是用自定义的窗口过程替换原有的窗口过程，用自定义的窗口过程来处理该窗口的消息响应。窗口子类化技术最大的特点就是能够截取 Windows的消息。</p><p><strong>BOOL EnableWindow( HWND hWnd, BOOL bEnable )</strong> 使能窗口的鼠标和键盘输入的消息。</p><p><strong>IsIconic</strong> 判断窗口是否最小化。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2021/7/3 上午9:03:57</span></div><!----></footer><!----><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.30a80d72.js" defer></script><script src="/assets/js/640.bba7dc0e.js" defer></script><script src="/assets/js/app.e61e0044.js" defer></script>
  </body>
</html>
